<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ä¼ä¸šæ”¿ç­–æŸ¥è¯¢</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
  background: #f5f7fa;
  color: #333;
  min-height: 100vh;
}

/* é¡¶éƒ¨æ  */
.header {
  background: linear-gradient(135deg, #1a73e8, #0d47a1);
  color: #fff;
  padding: 16px 20px;
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

.container { padding: 16px; max-width: 480px; margin: 0 auto; }

/* æ­¥éª¤æŒ‡ç¤ºå™¨ */
.steps {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 16px 0;
  align-items: center;
}
.step-dot {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: #ddd;
  color: #999;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 600;
  transition: all 0.3s;
}
.step-dot.active { background: #1a73e8; color: #fff; }
.step-dot.done { background: #34a853; color: #fff; }
.step-line { width: 32px; height: 2px; background: #ddd; }
.step-line.done { background: #34a853; }

/* å¡ç‰‡ */
.card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.card-title {
  font-size: 15px;
  font-weight: 600;
  color: #1a73e8;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* è¾“å…¥æ¡† */
.input-group { margin-bottom: 16px; }
.input-group label {
  display: block;
  font-size: 13px;
  color: #666;
  margin-bottom: 6px;
}
.input-group input {
  width: 100%;
  padding: 12px 14px;
  border: 1.5px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  outline: none;
  transition: border 0.2s;
}
.input-group input:focus { border-color: #1a73e8; }

/* æŒ‰é’® */
.btn {
  width: 100%;
  padding: 13px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s;
}
.btn:active { opacity: 0.8; }
.btn-primary { background: #1a73e8; color: #fff; }
.btn-success { background: #34a853; color: #fff; }
.btn-outline {
  background: #fff;
  color: #1a73e8;
  border: 1.5px solid #1a73e8;
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* å…¬å¸ä¿¡æ¯ */
.info-table { width: 100%; }
.info-row {
  display: flex;
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 14px;
}
.info-row:last-child { border-bottom: none; }
.info-label {
  width: 80px;
  flex-shrink: 0;
  color: #999;
}
.info-value {
  flex: 1;
  color: #333;
  word-break: break-all;
}

/* æ”¿ç­–åˆ—è¡¨ */
.policy-item {
  padding: 14px 0;
  border-bottom: 1px solid #f0f0f0;
}
.policy-item:last-child { border-bottom: none; }
.policy-title {
  font-size: 15px;
  font-weight: 500;
  color: #333;
  margin-bottom: 6px;
  line-height: 1.4;
}
.policy-meta {
  font-size: 12px;
  color: #999;
  margin-bottom: 6px;
}
.policy-summary {
  font-size: 13px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 8px;
}
.policy-links a {
  display: inline-block;
  font-size: 13px;
  color: #1a73e8;
  text-decoration: none;
  margin-right: 16px;
  padding: 4px 0;
}

/* åŠ è½½åŠ¨ç”» */
.loading {
  text-align: center;
  padding: 40px 0;
}
.spinner {
  width: 36px; height: 36px;
  border: 3px solid #e0e0e0;
  border-top-color: #1a73e8;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text {
  font-size: 14px;
  color: #999;
}

/* æœç´¢æ—¥å¿— */
.log-area {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 12px;
  margin-top: 12px;
  max-height: 200px;
  overflow-y: auto;
  font-size: 12px;
  color: #666;
  line-height: 1.8;
}

/* éšè— */
.hidden { display: none !important; }

/* ç©ºçŠ¶æ€ */
.empty {
  text-align: center;
  padding: 30px 0;
  color: #999;
  font-size: 14px;
}

/* tag */
.tag {
  display: inline-block;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  margin-right: 6px;
}
.tag-gov { background: #e8f0fe; color: #1a73e8; }
.tag-wechat { background: #e6f9e8; color: #34a853; }
.tag-other { background: #fef3e0; color: #f9a825; }

/* æ”¿ç­–é“¾æ¥åŒºåŸŸ */
.link-block {
  margin-top: 10px;
  padding: 8px 10px;
  background: #f0f4ff;
  border-radius: 6px;
  border-left: 3px solid #1a73e8;
}
.link-row {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  margin-bottom: 4px;
  font-size: 12px;
  line-height: 1.6;
  word-break: break-all;
}
.link-row:last-child { margin-bottom: 0; }
.link-row .link-label {
  flex-shrink: 0;
  font-weight: 600;
  color: #333;
  min-width: 70px;
}
.link-row a {
  color: #1a73e8;
  text-decoration: none;
  word-break: break-all;
}
.link-row a:hover { text-decoration: underline; }
.link-row .no-link {
  color: #bbb;
  font-style: italic;
}

/* æ‰¶æŒå†…å®¹ */
.support-block {
  margin-top: 8px;
  padding: 8px 10px;
  background: #eef7ff;
  border-radius: 6px;
  font-size: 13px;
  color: #1a73e8;
  line-height: 1.6;
  white-space: pre-line;
}

/* æ±‡æ€»è¡¨æ ¼ */
.summary-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin-top: 8px;
}
.summary-table th {
  background: #f0f4ff;
  padding: 8px 6px;
  text-align: left;
  font-weight: 600;
  color: #333;
  border-bottom: 2px solid #1a73e8;
  font-size: 12px;
}
.summary-table td {
  padding: 8px 6px;
  border-bottom: 1px solid #f0f0f0;
  vertical-align: top;
  line-height: 1.4;
}
.summary-table tr:hover { background: #fafbff; }
.score-bar {
  display: inline-block;
  height: 8px;
  border-radius: 4px;
  background: #e0e0e0;
  width: 60px;
  position: relative;
  vertical-align: middle;
}
.score-fill {
  height: 100%;
  border-radius: 4px;
  position: absolute;
  left: 0;
  top: 0;
}
.score-high { background: #34a853; }
.score-mid  { background: #fbbc04; }
.score-low  { background: #ea4335; }
.layer-badge {
  display: inline-block;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
  white-space: nowrap;
}
.layer-åŸºç¡€å±‚ { background: #e8f0fe; color: #1a73e8; }
.layer-å‘å±•å±‚ { background: #e6f9e8; color: #0d7a3f; }
.layer-äººæ‰å±‚ { background: #fef3e0; color: #e37400; }
.layer-è£èª‰å±‚ { background: #fce8e8; color: #c62828; }
.validity-tag {
  font-size: 11px;
  color: #666;
  white-space: nowrap;
}
</style>
</head>
<body>

<div class="header">ğŸ¢ ä¼ä¸šæ”¿ç­–æŸ¥è¯¢ <span style="font-size:12px; opacity:0.7;">v0.14</span></div>

<!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
<div class="container">
  <div class="steps">
    <div class="step-dot active" id="dot1">1</div>
    <div class="step-line" id="line1"></div>
    <div class="step-dot" id="dot2">2</div>
    <div class="step-line" id="line2"></div>
    <div class="step-dot" id="dot3">3</div>
    <div class="step-line" id="line3"></div>
    <div class="step-dot" id="dot4">4</div>
  </div>
</div>

<!-- ========== ç¬¬ä¸€æ­¥ï¼šè¾“å…¥å…¬å¸å ========== -->
<div class="container" id="step1">
  <div class="card">
    <div class="card-title">ğŸ“ è¾“å…¥å…¬å¸åç§°</div>
    <div class="input-group">
      <label>å…¬å¸å…¨ç§°</label>
      <input type="text" id="companyInput" placeholder="è¯·è¾“å…¥å…¬å¸åç§°" value="ä¸Šæµ·è¿å‡¡é¢†å…‰é€šä¿¡æœ‰é™å…¬å¸">
    </div>
    <button class="btn btn-primary" onclick="queryCompany()">æŸ¥è¯¢ä¼ä¸šä¿¡æ¯</button>
  </div>
</div>

<!-- ========== ç¬¬äºŒæ­¥ï¼šå±•ç¤ºå…¬å¸ä¿¡æ¯ ========== -->
<div class="container hidden" id="step2">
  <!-- å…¬å¸ä¿¡æ¯å¡ -->
  <div class="card">
    <div class="card-title">ğŸ¢ ä¼ä¸šåŸºæœ¬ä¿¡æ¯</div>
    <div class="info-table" id="companyInfo"></div>
  </div>

  <!-- æ“ä½œæŒ‰é’® -->
  <div class="card">
    <div class="card-title">ğŸ§  æ™ºèƒ½æœç´¢</div>
    <p style="font-size:13px; color:#666; margin-bottom:14px; line-height:1.5;">
      AI åˆ†æä¼ä¸šä¿¡æ¯ï¼Œè‡ªåŠ¨æ‹†åˆ†å¤šå±‚æœç´¢ä»»åŠ¡ï¼ˆåŸºç¡€å±‚ã€å‘å±•å±‚ã€äººæ‰å±‚ã€è£èª‰å±‚ï¼‰ï¼Œæ™ºèƒ½åŒ¹é…æ”¿åºœå¥–åŠ±/æ‰¶æŒæ”¿ç­–ã€‚
    </p>
    <button class="btn btn-success" onclick="startPolicySearch()">ğŸš€ å¼€å§‹æ™ºèƒ½æœç´¢</button>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="goBack()">â† é‡æ–°æŸ¥è¯¢</button>
  </div>
</div>

<!-- ========== ç¬¬ä¸‰æ­¥ï¼šæ”¿ç­–æœç´¢ç»“æœ ========== -->
<div class="container hidden" id="step3">
  <!-- æœç´¢ä¸­ï¼ˆspinnerï¼‰ -->
  <div class="card" id="searchingCard">
    <div class="loading">
      <div class="spinner"></div>
      <div class="loading-text" id="searchStatus">æ­£åœ¨æœç´¢æ”¿ç­–...</div>
    </div>
  </div>

  <!-- æœç´¢æ—¥å¿—ï¼ˆå§‹ç»ˆå¯è§ï¼‰ -->
  <div class="card" id="logCard">
    <div class="card-title" style="cursor:pointer;" onclick="toggleLog()">
      ğŸ“‹ æœç´¢æ—¥å¿—
      <span id="logToggle" style="font-size:12px; color:#999; font-weight:400; margin-left:auto;">â–¼</span>
    </div>
    <div class="log-area" id="searchLog" style="max-height:300px;"></div>
  </div>

  <!-- ç»“æœ -->
  <div class="card hidden" id="resultCard">
    <div class="card-title">ğŸ¯ æœç´¢ç»“æœ <span id="resultCount" style="font-size:12px; color:#999; font-weight:400;"></span></div>
    <div id="policyList"></div>
  </div>

  <div class="hidden" id="resultActions" style="margin-bottom:20px;">
    <button class="btn btn-success" onclick="goToSummary()">ğŸ“Š è¿›å…¥æ”¿ç­–æ±‡æ€»</button>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="startPolicySearch()">ğŸ”„ é‡æ–°æœç´¢</button>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="goBack()">â† è¿”å›æŸ¥è¯¢</button>
  </div>
</div>

<!-- ========== ç¬¬å››æ­¥ï¼šæ”¿ç­–æ±‡æ€» ========== -->
<div class="container hidden" id="step4">
  <div class="card">
    <div class="card-title">ğŸ“Š æ”¿ç­–æ±‡æ€»æ’å</div>
    <p style="font-size:13px; color:#666; margin-bottom:12px; line-height:1.5;">
      æŒ‰ä¸šåŠ¡å±‚åˆ†ç»„ï¼ŒæŒ‰åŒ¹é…åº¦æ’åºï¼Œå±•ç¤ºé‡‘é¢èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚
    </p>
    <div id="summaryContent"></div>
  </div>

  <div style="margin-bottom:20px;">
    <button class="btn btn-outline" onclick="setStep(3)">â† è¿”å›æœç´¢ç»“æœ</button>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="startPolicySearch()">ğŸ”„ é‡æ–°æœç´¢</button>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="goBack()">â† è¿”å›æŸ¥è¯¢</button>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mock ä¼æŸ¥æŸ¥æ•°æ®
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MOCK_COMPANIES = {
  "ä¸Šæµ·è¿å‡¡é¢†å…‰é€šä¿¡æœ‰é™å…¬å¸": {
    company_name: "ä¸Šæµ·è¿å‡¡é¢†å…‰é€šä¿¡æœ‰é™å…¬å¸",
    legal_person: "å¼ æŸ",
    registered_capital: "100ä¸‡äººæ°‘å¸",
    established_date: "2023-11-23",
    status: "å­˜ç»­",
    registered_address: "ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº",
    district: "æµ¦ä¸œæ–°åŒº",
    industry: "å…‰é€šä¿¡è®¾å¤‡åˆ¶é€ ",
    company_type: "æœ‰é™è´£ä»»å…¬å¸ï¼ˆè‡ªç„¶äººæŠ•èµ„æˆ–æ§è‚¡ï¼‰",
    scale: "å°å¾®ä¼ä¸š",
    business_scope: "å…‰é€šä¿¡è®¾å¤‡ã€å…‰ç”µå­å™¨ä»¶çš„ç ”å‘ã€ç”Ÿäº§å’Œé”€å”®ï¼›é€šä¿¡æŠ€æœ¯å’¨è¯¢ï¼›è´§ç‰©åŠæŠ€æœ¯çš„è¿›å‡ºå£ä¸šåŠ¡",
    social_credit_code: "91310115XXXXXXXXXX",
    tags: ["å°å¾®ä¼ä¸š", "å…‰é€šä¿¡", "æµ¦ä¸œæ–°åŒº", "ç§‘æŠ€å‹"]
  }
};

// Mock æ”¿ç­–æ•°æ®ï¼ˆæ¨¡æ‹Ÿæœç´¢ç»“æœï¼‰
const MOCK_POLICIES = [
  {
    policy_title: "æµ¦ä¸œæ–°åŒºä¿ƒè¿›é›†æˆç”µè·¯å’Œæ–°ä¸€ä»£é€šä¿¡äº§ä¸šé«˜è´¨é‡å‘å±•ä¸“é¡¹æ“ä½œç»†åˆ™",
    source: "æµ¦ä¸œæ–°åŒºæ”¿åºœ",
    url: "https://www.pudong.gov.cn/zwgk/gfxwj-kjwzcwj/2024/299/333469.html",
    pdf_url: "https://www.pudong.gov.cn/zwgk/gfxwj-kjwzcwj/2024/299/333469/a9967b3e5807430eabc4808077f07d69.pdf",
    summary: "å¯¹å…‰é€šä¿¡ã€é›†æˆç”µè·¯ç­‰æ–°ä¸€ä»£ä¿¡æ¯é€šä¿¡é¢†åŸŸçš„ä¼ä¸šï¼Œç»™äºˆç ”å‘æŠ•å…¥è¡¥è´´ã€äº§ä¸šåŒ–é¡¹ç›®èµ„åŠ©ç­‰æ”¯æŒï¼Œå•ä¸ªé¡¹ç›®æœ€é«˜èµ„åŠ©500ä¸‡å…ƒã€‚",
    publish_date: "2024-06-15",
    applicable: "å…‰é€šä¿¡è®¾å¤‡åˆ¶é€ ä¼ä¸š"
  },
  {
    policy_title: "ä¸Šæµ·å¸‚å°å¾®ä¼ä¸šåˆ›ä¸šæ‹…ä¿è´·æ¬¾è´´æ¯åŠå¥–è¡¥å®æ–½åŠæ³•",
    source: "ä¸Šæµ·å¸‚äººåŠ›èµ„æºå’Œç¤¾ä¼šä¿éšœå±€",
    url: "https://rsj.sh.gov.cn/txwjgzdt_17408/20240301/001.html",
    pdf_url: "",
    summary: "ç¬¦åˆæ¡ä»¶çš„å°å¾®ä¼ä¸šå¯ç”³è¯·æœ€é«˜400ä¸‡å…ƒçš„åˆ›ä¸šæ‹…ä¿è´·æ¬¾ï¼Œæ”¿åºœç»™äºˆå…¨é¢è´´æ¯ã€‚é€‚ç”¨äºæˆç«‹5å¹´å†…çš„å°å¾®ä¼ä¸šã€‚",
    publish_date: "2024-03-01",
    applicable: "å°å¾®ä¼ä¸š"
  },
  {
    policy_title: "æµ¦ä¸œæ–°åŒºå…³äºä¿ƒè¿›ç§‘æŠ€åˆ›æ–°ä¸­å¿ƒæ ¸å¿ƒåŠŸèƒ½åŒºå»ºè®¾çš„è‹¥å¹²æ”¿ç­–æªæ–½",
    source: "æµ¦ä¸œæ–°åŒºç§‘ç»å§”",
    url: "https://www.pudong.gov.cn/zwgk/gfxwj-kjwzcwj/2024/156/322890.html",
    pdf_url: "",
    summary: "å¯¹é¦–æ¬¡è®¤å®šçš„é«˜æ–°æŠ€æœ¯ä¼ä¸šç»™äºˆä¸€æ¬¡æ€§20ä¸‡å…ƒå¥–åŠ±ï¼›å¯¹ç§‘æŠ€å‹ä¸­å°ä¼ä¸šç ”å‘è´¹ç”¨åŠ è®¡æ‰£é™¤ç»™äºˆé¢å¤–è¡¥è´´ã€‚",
    publish_date: "2024-04-20",
    applicable: "ç§‘æŠ€å‹ä¸­å°ä¼ä¸šã€é«˜æ–°æŠ€æœ¯ä¼ä¸š"
  },
  {
    policy_title: "ä¸Šæµ·å¸‚æˆ˜ç•¥æ€§æ–°å…´äº§ä¸šå’Œå…ˆå¯¼äº§ä¸šå‘å±•ä¸“é¡¹èµ„é‡‘ç®¡ç†åŠæ³•",
    source: "ä¸Šæµ·å¸‚ç»ä¿¡å§”",
    url: "https://jjxxw.sh.gov.cn/flfg/20240510/001.html",
    pdf_url: "",
    summary: "æ”¯æŒæ–°ä¸€ä»£ä¿¡æ¯æŠ€æœ¯ï¼ˆå«å…‰é€šä¿¡ï¼‰äº§ä¸šå‘å±•ã€‚å¯¹ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®ç»™äºˆä¸è¶…è¿‡é¡¹ç›®æ€»æŠ•èµ„30%çš„èµ„åŠ©ï¼Œå•ä¸ªé¡¹ç›®æœ€é«˜3000ä¸‡å…ƒã€‚",
    publish_date: "2024-05-10",
    applicable: "æ–°ä¸€ä»£ä¿¡æ¯æŠ€æœ¯ä¼ä¸š"
  },
  {
    policy_title: "æµ¦ä¸œæ–°åŒºä¸­å°å¾®ä¼ä¸šæ”¿ç­–æ€§èèµ„æ‹…ä¿åŸºé‡‘ç®¡ç†åŠæ³•",
    source: "æµ¦ä¸œæ–°åŒºé‡‘èå·¥ä½œå±€",
    url: "https://www.pudong.gov.cn/zwgk/gfxwj-zczjwj/2024/098/319560.html",
    pdf_url: "",
    summary: "ä¸ºæµ¦ä¸œæ–°åŒºæ³¨å†Œçš„ä¸­å°å¾®ä¼ä¸šæä¾›æœ€é«˜1000ä¸‡å…ƒçš„èèµ„æ‹…ä¿æ”¯æŒï¼Œæ‹…ä¿è´¹ç‡ä¸è¶…è¿‡1%ã€‚",
    publish_date: "2024-02-28",
    applicable: "æµ¦ä¸œæ–°åŒºä¸­å°å¾®ä¼ä¸š"
  }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// çŠ¶æ€ç®¡ç†
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCompany = null;
let lastPolicies = [];  // ä¿å­˜æœç´¢ç»“æœä¾›æ±‡æ€»é¡µç”¨

function setStep(n) {
  for (let i = 1; i <= 4; i++) {
    const dot = document.getElementById('dot' + i);
    dot.classList.remove('active', 'done');
    if (i < n) dot.classList.add('done');
    else if (i === n) dot.classList.add('active');
  }
  document.getElementById('line1').classList.toggle('done', n > 1);
  document.getElementById('line2').classList.toggle('done', n > 2);
  document.getElementById('line3').classList.toggle('done', n > 3);

  document.getElementById('step1').classList.toggle('hidden', n !== 1);
  document.getElementById('step2').classList.toggle('hidden', n !== 2);
  document.getElementById('step3').classList.toggle('hidden', n !== 3);
  document.getElementById('step4').classList.toggle('hidden', n !== 4);
}

function goToSummary() {
  setStep(4);
  renderSummary(lastPolicies);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢å…¬å¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function queryCompany() {
  const name = document.getElementById('companyInput').value.trim();
  if (!name) { alert('è¯·è¾“å…¥å…¬å¸åç§°'); return; }

  // Mock æŸ¥è¯¢ï¼ˆåç»­æ›¿æ¢ä¸ºä¼æŸ¥æŸ¥ APIï¼‰
  const data = MOCK_COMPANIES[name];
  if (!data) {
    alert('æœªæ‰¾åˆ°è¯¥å…¬å¸ä¿¡æ¯ï¼ˆå½“å‰ä¸ºæ¼”ç¤ºæ•°æ®ï¼‰');
    return;
  }

  currentCompany = data;
  renderCompanyInfo(data);
  setStep(2);
}

function renderCompanyInfo(data) {
  const fields = [
    ['å…¬å¸åç§°', data.company_name],
    ['æ³•å®šä»£è¡¨äºº', data.legal_person],
    ['æ³¨å†Œèµ„æœ¬', data.registered_capital],
    ['æˆç«‹æ—¥æœŸ', data.established_date],
    ['ç»è¥çŠ¶æ€', data.status],
    ['æ³¨å†Œåœ°å€', data.registered_address],
    ['æ‰€å±è¡Œä¸š', data.industry],
    ['ä¼ä¸šç±»å‹', data.company_type],
    ['ä¼ä¸šè§„æ¨¡', data.scale],
    ['ç»è¥èŒƒå›´', data.business_scope],
  ];

  const html = fields.map(([label, value]) =>
    `<div class="info-row">
      <div class="info-label">${label}</div>
      <div class="info-value">${value || '-'}</div>
    </div>`
  ).join('');

  document.getElementById('companyInfo').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¬¬äºŒæ­¥â†’ç¬¬ä¸‰æ­¥ï¼šæœç´¢æ”¿ç­–
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startPolicySearch() {
  setStep(3);
  document.getElementById('searchingCard').classList.remove('hidden');
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('resultActions').classList.add('hidden');

  const log = document.getElementById('searchLog');
  const status = document.getElementById('searchStatus');
  log.innerHTML = '';

  function ts() { return new Date().toLocaleTimeString('zh-CN', {hour12:false}); }
  function addLog(msg) {
    log.innerHTML += `<span style="color:#aaa">[${ts()}]</span> ${msg}\n`;
    log.scrollTop = log.scrollHeight;
  }

  addLog('ğŸ§  AI æ™ºèƒ½æœç´¢å¯åŠ¨ä¸­...');
  status.textContent = 'AI æ­£åœ¨åˆ†æä¼ä¸šä¿¡æ¯...';

  // æ„å»ºæŸ¥è¯¢å‚æ•° â€” ä¼ é€’ä¼ä¸šå®Œæ•´ä¿¡æ¯
  const params = new URLSearchParams({
    company_name: currentCompany.company_name || '',
    industry: currentCompany.industry || 'å…‰é€šä¿¡',
    region: 'ä¸Šæµ·',
    district: currentCompany.district || '',
    tags: (currentCompany.tags || []).join(','),
    registered_capital: currentCompany.registered_capital || '',
    employees: currentCompany.scale || '',
    founded: currentCompany.established_date || '',
  });

  // SSE è¿æ¥çœŸå® API
  const es = new EventSource(`/api/policy-search/stream?${params}`);

  es.onmessage = function(event) {
    let data;
    try { data = JSON.parse(event.data); } catch(e) { return; }

    if (data.type === 'log') {
      addLog(data.message);
      // åªæŠŠå…³é”®æ­¥éª¤æ˜¾ç¤ºåœ¨çŠ¶æ€æ ï¼Œå¿½ç•¥è­¦å‘Šç±»æ—¥å¿—
      const msg = data.message;
      if (!msg.includes('timeout') && !msg.includes('WARNING') && !msg.includes('readiness')) {
        const short = msg.length > 60 ? msg.substring(0, 60) + '...' : msg;
        status.textContent = short;
      }
    }
    else if (data.type === 'status') {
      addLog(`ğŸ“¡ ${data.message}`);
      status.textContent = data.message;
    }
    else if (data.type === 'result') {
      const result = data.data;
      addLog(`âœ… æœç´¢å®Œæˆ! è€—æ—¶ ${result.duration}sï¼ŒWorker: ${result.worker || 'unknown'}ï¼Œæ‰¾åˆ° ${result.policy_count || 0} æ¡æ”¿ç­–`);

      // ç»Ÿä¸€æ ¼å¼: WorkerResult.policies
      let policies = result.policies || [];

      // å…¼å®¹æ—§æ ¼å¼
      if (!policies.length && result.structured && result.structured.policies) {
        policies = result.structured.policies;
      } else if (!policies.length && result.result && typeof result.result === 'object' && result.result.policies) {
        policies = result.result.policies;
      }

      if (result.search_notes) {
        addLog(`ğŸ“ ${result.search_notes}`);
      } else if (result.structured && result.structured.search_notes) {
        addLog(`ğŸ“ ${result.structured.search_notes}`);
      }

      document.getElementById('searchingCard').classList.add('hidden');
      document.getElementById('resultCard').classList.remove('hidden');
      document.getElementById('resultActions').classList.remove('hidden');
      lastPolicies = policies;
      renderPolicies(policies);
    }
    else if (data.type === 'done') {
      es.close();
    }
    else if (data.type === 'error') {
      addLog(`âŒ é”™è¯¯: ${data.message}`);
      status.textContent = 'æœç´¢å‡ºé”™';
      document.getElementById('searchingCard').classList.add('hidden');
      document.getElementById('resultActions').classList.remove('hidden');
      es.close();
    }
    // heartbeat â€” ignore
  };

  es.onerror = function() {
    addLog('âŒ è¿æ¥æ–­å¼€ï¼Œæœç´¢å¯èƒ½ä»åœ¨è¿è¡Œ...');
    status.textContent = 'è¿æ¥æ–­å¼€';
    es.close();
  };
}

function renderPolicies(policies) {
  document.getElementById('resultCount').textContent = `å…± ${policies.length} æ¡`;

  if (!policies.length) {
    document.getElementById('policyList').innerHTML = '<div class="empty">æš‚æœªæ‰¾åˆ°ç›¸å…³æ”¿ç­–</div>';
    return;
  }

  const html = policies.map((p, i) => {
    const source = p.source || 'æœªçŸ¥æ¥æº';
    const sourceTag = source.includes('åŒº') || source.includes('gov') ? 'tag-gov' :
                      source.includes('å¾®ä¿¡') ? 'tag-wechat' : 'tag-other';
    const applicable = p.industry || p.applicable_industry || p.applicable || '';
    const keySupport = p.support || p.key_support || '';
    const title = p.title || p.policy_title || 'æœªå‘½åæ”¿ç­–';
    const date = p.date || p.publish_date || '';
    const urlDisplay = p.url
      ? `<a href="${p.url}" target="_blank">${p.url}</a>`
      : '<span class="no-link">æœªæ‰¾åˆ°</span>';
    const pdfDisplay = p.pdf_url
      ? `<a href="${p.pdf_url}" target="_blank">${p.pdf_url}</a>`
      : '<span class="no-link">æœªæ‰¾åˆ°</span>';

    return `
    <div class="policy-item">
      <div class="policy-title">${i + 1}. ${title}</div>
      <div class="policy-meta">
        <span class="tag ${sourceTag}">${source}</span>
        ${date ? 'ğŸ“… ' + date : ''}
        ${applicable ? ' Â· é€‚ç”¨: ' + applicable : ''}
      </div>
      <div class="policy-summary">${p.summary || 'æš‚æ— æ‘˜è¦'}</div>
      ${keySupport ? `<div class="support-block">ğŸ’° ${keySupport}</div>` : ''}
      <div class="link-block">
        <div class="link-row">
          <span class="link-label">ğŸ“„ åŸæ–‡é“¾æ¥</span>
          ${urlDisplay}
        </div>
        <div class="link-row">
          <span class="link-label">ğŸ“¥ PDFä¸‹è½½</span>
          ${pdfDisplay}
        </div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('policyList').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æ±‡æ€»è¡¨æ ¼ï¼ˆæŒ‰å±‚åˆ†ç»„ + æ’åï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary(policies) {
  const layers = ['åŸºç¡€å±‚', 'å‘å±•å±‚', 'äººæ‰å±‚', 'è£èª‰å±‚'];
  const grouped = {};
  layers.forEach(l => grouped[l] = []);
  const ungrouped = [];

  policies.forEach((p, i) => {
    const layer = p.layer || '';
    const item = { ...p, _rank: i + 1 };
    if (grouped[layer]) grouped[layer].push(item);
    else ungrouped.push(item);
  });

  let html = '';

  layers.forEach(layer => {
    const items = grouped[layer];
    if (!items.length) return;

    html += `<div style="margin-bottom:16px;">
      <div style="margin-bottom:6px;">
        <span class="layer-badge layer-${layer}">${layer}</span>
        <span style="font-size:12px; color:#999; margin-left:6px;">${items.length} æ¡æ”¿ç­–</span>
      </div>
      <table class="summary-table">
        <tr>
          <th style="width:30px;">#</th>
          <th>æ”¿ç­–åç§°</th>
          <th style="width:55px;">è¯„åˆ†</th>
          <th style="width:80px;">é‡‘é¢</th>
          <th style="width:80px;">æœ‰æ•ˆæœŸ</th>
        </tr>`;

    items.forEach((p, j) => {
      const score = p.relevance || 0;
      const scoreClass = score >= 70 ? 'score-high' : score >= 50 ? 'score-mid' : 'score-low';
      const title = p.title || p.policy_title || 'æœªå‘½å';
      const shortTitle = title.length > 22 ? title.substring(0, 22) + '...' : title;
      const validity = p.validity || 'â€”';
      const amount = p.amount || 'â€”';

      html += `<tr>
        <td style="color:#999; font-size:12px;">${j + 1}</td>
        <td>
          ${p.url ? `<a href="${p.url}" target="_blank" style="color:#333; text-decoration:none; font-size:13px;">${shortTitle}</a>` : `<span style="font-size:13px;">${shortTitle}</span>`}
        </td>
        <td>
          <div style="display:flex; align-items:center; gap:4px;">
            <span style="font-size:12px; font-weight:600; color:${score >= 70 ? '#34a853' : score >= 50 ? '#f9a825' : '#ea4335'};">${score}</span>
            <div class="score-bar"><div class="score-fill ${scoreClass}" style="width:${score}%;"></div></div>
          </div>
        </td>
        <td style="font-size:12px; color:#1a73e8; font-weight:500;">${amount}</td>
        <td class="validity-tag">${validity}</td>
      </tr>`;
    });

    html += '</table></div>';
  });

  // æœªåˆ†ç±»
  if (ungrouped.length) {
    html += `<div style="margin-top:12px; font-size:12px; color:#999;">æœªåˆ†ç±»: ${ungrouped.length} æ¡</div>`;
  }

  if (!html) {
    html = '<div class="empty">æš‚æ— æ±‡æ€»æ•°æ®</div>';
  }

  document.getElementById('summaryContent').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// è¿”å›
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goBack() {
  setStep(1);
}

function toggleLog() {
  const log = document.getElementById('searchLog');
  const toggle = document.getElementById('logToggle');
  if (log.style.display === 'none') {
    log.style.display = '';
    toggle.textContent = 'â–¼';
  } else {
    log.style.display = 'none';
    toggle.textContent = 'â–¶';
  }
}
</script>

</body>
</html>
